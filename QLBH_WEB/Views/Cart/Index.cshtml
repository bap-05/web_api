@model QLBH_WEB.Models.Cart

@{
    ViewBag.Title = "Giỏ hàng";
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["CartError"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["CartError"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["CartSuccess"] != null)
{
    <div class="alert alert-info alert-dismissible fade show" role="alert">
        @TempData["CartSuccess"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@section Styles {
    <link href="@Url.Content("~/Content/css_main/Cart.css")" rel="stylesheet" type="text/css" />
}

<div class="cart-page-wrapper">
    <div class="center_title_bar">Giỏ hàng của bạn</div>

    @if (Model == null || !Model.Items.Any())
    {
        <p style="padding: 20px;">Giỏ hàng của bạn đang trống.</p>
        <div class="cart-actions">
            @Html.ActionLink("Tiếp tục mua sắm", "Index", "Home", null, new { @class = "btn-cart btn-continue" })
        </div>
    }
    else
    {
        // Sử dụng một form duy nhất cho tất cả các hành động
        using (Html.BeginForm("HandleCartAction", "Cart", FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            <table class="cart-table">
                <thead>
                    <tr>
                        <th>Chọn</th>
                        <th>Hình ảnh</th>
                        <th>Tên sản phẩm</th>
                        <th>Đơn giá</th>
                        <th>Số lượng</th>
                        <th>Thành tiền</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Items.Values)
                    {
                        <tr>
                            <td>
                                <input type="checkbox" name="selectedItems" value="@item.SanPham.MASANPHAM" checked />
                            </td>
                            <td>
                                <img src="@Url.Content("~/Content/images/" + (item.SanPham.HINHANH ?? "no-image.png"))"
                                     alt="@item.SanPham.TENSANPHAM" class="cart-product-image" />
                            </td>
                            <td>@item.SanPham.TENSANPHAM</td>
                            <td>@string.Format("{0:N0} $", item.SanPham.DONGIA)</td>
                            <td>
                                <input type="number" name="quantity_@item.SanPham.MASANPHAM" value="@item.SoLuong" min="0" style="width: 60px;" />
                            </td>
                            <td>@string.Format("{0:N0} $", item.ThanhTien)</td>
                            <td>
                                @Html.ActionLink("Xóa", "RemoveFromCart", new { id = item.SanPham.MASANPHAM }, new { @class = "btn-cart btn-delete" })
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="cart-total-section">
                <h4>Tổng cộng</h4>
                <p class="grand-total">@string.Format("{0:N0} $", Model.GetTotal())</p>
            </div>

            <div class="cart-actions">
                @Html.ActionLink("Quay lại trang chủ", "Index", "Home", null, new { @class = "btn-cart btn-continue" })

                <button type="submit" name="action" value="update" class="btn-cart btn-update">Cập nhật</button>
                <button type="submit" formaction="@Url.Action("PrepareCheckout", "Cart")" formmethod="post" class="btn-cart btn-continue">
                    Thanh toán
                </button>
            </div>
        }
    }
</div>